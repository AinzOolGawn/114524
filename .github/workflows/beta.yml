name: Beta CI
on:
 workflow_dispatch:
  inputs:
   ci_upload:
    description: 'Upload to SnapEnhance CI Channel'
    required: false
    type: boolean

jobs:
 build:
  runs-on: ubuntu-latest
  steps:
   - name: Checkout Repository with Submodules
     uses: actions/checkout@v4
     with:
      submodules: 'recursive'

   - name: Setup Java 17 with Gradle Cache
     uses: actions/setup-java@v4
     with:
      java-version: '17'
      distribution: 'temurin'
      cache: gradle

   - name: Grant Execute Permission for gradlew
     run: chmod +x gradlew

   - name: Clean Gradle Cache
     run: ./gradlew clean

   - name: Build with Gradle Wrapper and Assemble Debug APKs
     run: ./gradlew assembleDebug

   - name: Generate Version File with Gradle Wrapper
     run: ./gradlew getVersion

   - name: Set Version to Environment Variable
     id: version-env
     run: |
      echo "version=$(cat app/build/version.txt)" >> $GITHUB_ENV
      echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

   - name: Git Branch Name
     id: git-branch-name
     uses: EthanSK/git-branch-name-action@v1

   - name: Rename APK Files
     run: |
      mv app/build/outputs/apk/armv8/debug/*.apk app/build/outputs/apk/armv8/debug/SnapEnhance-${{ env.version }}-ARMv8-${{ steps.version-env.outputs.sha_short }}.apk
      mv app/build/outputs/apk/armv7/debug/*.apk app/build/outputs/apk/armv7/debug/SnapEnhance-${{ env.version }}-ARMv7-${{ steps.version-env.outputs.sha_short }}.apk
      mv app/build/outputs/apk/all/debug/*.apk app/build/outputs/apk/all/debug/SnapEnhance-${{ env.version }}-Universal-${{ steps.version-env.outputs.sha_short }}.apk

   - name: Upload Manager APK to GitHub Actions
     uses: actions/upload-artifact@v3
     with:
      name: Manager
      path: manager/build/outputs/apk/debug/*.apk

   - name: Upload Core APK to GitHub Actions
     uses: actions/upload-artifact@v3
     with:
      name: Core
      path: app/build/outputs/apk/core/debug/*.apk

   - name: Upload SnapEnhance ARMv8 Debug APK to GitHub Actions
     uses: actions/upload-artifact@v3
     with:
      name: SnapEnhance-ARMv8-Debug
      path: app/build/outputs/apk/armv8/debug/*.apk

   - name: Upload SnapEnhance ARMv7 Debug APK to GitHub Actions
     uses: actions/upload-artifact@v3
     with:
      name: SnapEnhance-ARMv7-Debug
      path: app/build/outputs/apk/armv7/debug/*.apk

   - name: Upload SnapEnhance Universal Debug APK to GitHub Actions
     uses: actions/upload-artifact@v3
     with:
      name: SnapEnhance-Universal-Debug
      path: app/build/outputs/apk/all/debug/*.apk

   - name: Upload SnapEnhance ARMv8 Debug APK to SnapEnhance Telegram Channel
     if:  ${{ inputs.ci_upload }}
     run: node ./.github/workflows/upload.js -t "${{ secrets.TELEGRAM_BOT_TOKEN }}" -f "app/build/outputs/apk/armv8/debug/SnapEnhance-${{ env.version }}-ARMv8-${{ steps.version-env.outputs.sha_short }}.apk" --caption "A new commit has been pushed to the ${{ env.GIT_BRANCH_NAME }} branch! ${{ steps.version-env.outputs.sha_short }}" --chatid "${{ secrets.TELEGRAM_CHAT_ID }}"

   - name: Upload SnapEnhance ARMv7 Debug APK to SnapEnhance Telegram Channel
     if:  ${{ inputs.ci_upload }}
     run: node ./.github/workflows/upload.js -t "${{ secrets.TELEGRAM_BOT_TOKEN }}" -f "app/build/outputs/apk/armv7/debug/SnapEnhance-${{ env.version }}-ARMv7-${{ steps.version-env.outputs.sha_short }}.apk" --chatid "${{ secrets.TELEGRAM_CHAT_ID }}"